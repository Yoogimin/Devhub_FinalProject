<!DOCTYPE html>
<html lang="ko">

<head>
    <link rel="stylesheet" href="/libs/remixicon/fonts/remixicon.css">
    <link rel="stylesheet" href="/libs/swiper/swiper-bundle.css">
    <link rel="stylesheet" href="/libs/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevHub 회원가입</title>
    <link rel="shortcut icon" type="images/x-icon" href="/images/favicon.svg">
    <link rel="stylesheet" href="/css/member/signup.css">
</head>

<body data-bs-spy="scroll" data-bs-target="#navbarCollapse">

<section class="section login-section">
    <div class="container">
        <div class="login-content py-5 px-2 rounded-4">
            <div class="row align-items-center justify-content-evenly position-relative">
                <div class="col-lg-5">
                    <div class="card border-0 rounded-4">
                        <div class="card-body p-lg-4 p-3">
                            <!-- 첫 번째 폼 컨테이너 -->
                            <div id="first-form-container">
                                <div class="text-start mt-3 px-lg-4 px-2">
                                    <div class="navbar-brand logo mb-3">
                                        <a class="navbar-caption fs-4 text-dark ls-1 fw-bold" href="index.html"><i class="ri-robot-2-fill text-danger fs-3 me-1"></i>Dev<b class="text-danger">Hub</b></a>
                                    </div>
                                    <div class="login-title">
                                        <h5 class="text-primary fw-semibold">계정 생성하기</h5>
                                    </div>
                                    <p class="text-muted mb-0">다시 오신 것을 환영합니다! 계정을 등록해 주세요.</p>
                                    <div class="login-btn main-btn mt-4">
                                        <a href="javascript:void(0);" class="btn btn-white border"><img src="images/google.png" alt="" class="me-2 border-0">Google</a>
                                        <a href="javascript:void(0);" class="btn btn-white border ms-lg-3 ms-0 my-2"><img src="images/facebook.png" alt="" class="me-2 border-0">Facebook</a>
                                    </div>
                                    <p class="text-center my-4 line">
                                        <small>또는</small>
                                    </p>
                                </div>
                                <div class="px-lg-4 px-2">
                                    <form id="first-form">
                                        <div class="form-group input-group">
                                            <span class="input-group-text" id="basic-addon1.1"><i class="ri-user-line"></i></span>
                                            <input type="text" class="form-control" id="name" placeholder="이름 입력" required>
                                            <span id="checkName"></span> <!-- 이름 유효성 검사 결과 메시지 표시 -->
                                        </div>
                                        <div class="form-group input-group">
                                            <span class="input-group-text" id="basic-addon1.2"><i class="ri-mail-line"></i></span>
                                            <input type="email" class="form-control" id="email" placeholder="이메일 입력" required>
                                            <button type="button" class="btn btn-secondary ms-2" id="send-code-btn">보내기</button>
                                        </div>
                                        <div class="form-group input-group mt-3" id="verification-code-group">
                                            <div class="form-group input-group">
                                                <span class="input-group-text" id="basic-addon2"><i class="ri-lock-line"></i></span>
                                                <input type="text" class="form-control" id="verification-code" placeholder="인증번호 입력" required />
                                            </div>
                                        </div>
                                        <div class="alertMessage" id="alertMessage1"></div>
                                        <div class="form-check mt-4 d-flex">
                                            <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault">
                                            <label class="form-check-label ms-2" for="flexCheckDefault">기억하기</label>
                                            <div class="ms-auto form-check">
                                                <input type="checkbox" class="form-check-input" id="exampleCheck1">
                                                <label class="form-check-label text-muted" for="exampleCheck1">저는 <a href="#" class="text-danger">이용 약관</a>에 동의합니다.</label>
                                            </div>
                                        </div>
                                        <div class="d-grid mt-3">
                                            <button type="submit" class="btn btn-primary">가입</button>
                                        </div>
                                        <p class="text-center mt-3 mb-0"><small>이미 계정이 있으신가요? <a href="login" class="fs-6 text-primary">로그인!</a></small></p>
                                    </form>
                                </div>
                            </div>

                            <!-- 두 번째 폼 컨테이너 -->
                            <div id="second-form-container" class="fade-in">
                                <div class="text-start mt-3 px-lg-4 px-2">
                                    <div class="navbar-brand logo mb-3">
                                        <a class="navbar-caption fs-4 text-dark ls-1 fw-bold" href="index.html"><i class="ri-robot-2-fill text-danger fs-3 me-1"></i>Dev<b class="text-danger">Hub</b></a>
                                    </div>
                                    <div class="login-title">
                                        <h5 class="text-primary fw-semibold">추가 정보 입력</h5>
                                    </div>
                                    <p class="text-muted mb-0">계정 생성을 위해 추가 정보를 입력해 주세요.</p>
                                </div>
                                <div class="px-lg-4 px-2">
                                    <form id="second-form" action="mJoin" method="post" enctype="multipart/form-data" name="mJoinForm">
                                        <!-- 아이디 입력 필드 -->
                                        <div class="form-group input-group mb-3">
                                            <span class="input-group-text" id="basic-addon2.1"><i class="ri-user-line"></i></span>
                                            <input type="text" class="form-control" id="MId" name="MId" placeholder="아이디" required />
                                            <br /><span id="check1"></span>
                                        </div>
                                        <!-- 비밀번호 입력 필드 -->
                                        <div class="form-group input-group mb-3">
                                            <span class="input-group-text" id="basic-addon2.2"><i class="ri-lock-line"></i></span>
                                            <input type="password" class="form-control" id="MPw" name="MPw" placeholder="비밀번호" required />
                                            <br /><span id="check2"></span>
                                        </div>
                                        <!-- 비밀번호 확인 필드 -->
                                        <div class="form-group input-group mb-3">
                                            <span class="input-group-text" id="basic-addon2.3"><i class="ri-lock-line"></i></span>
                                            <input type="password" class="form-control" id="CheckPw" placeholder="비밀번호 확인" required />
                                            <button type="button" class="btn btn-secondary" id="check-pw-btn">확인</button>
                                            <br /><span id="check3"></span>
                                        </div>

                                        <!-- 생년월일 입력 필드 -->
                                        <div class="form-group input-group mb-3">
                                            <span class="input-group-text" id="basic-addon2.4"><i class="ri-calendar-line"></i></span>
                                            <input type="date" class="form-control" id="MBirth" name="MBirth" placeholder="생년월일" required>
                                        </div>
                                        <!-- 성별 선택 필드 -->
                                        <div class="form-group mb-3">
                                            <span class="d-block mb-2">성별</span>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="MGender" id="male" value="남성" required>
                                                <label class="form-check-label" for="male">남성</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="MGender" id="female" value="여성" required>
                                                <label class="form-check-label" for="female">여성</label>
                                            </div>
                                        </div>
                                        <!-- 연락처 입력 필드 -->
                                        <div class="form-group input-group mb-3">
                                            <span class="input-group-text" id="basic-addon1"><i class="ri-phone-line"></i></span>
                                            <input type="text" class="form-control" id="MPhone" name="MPhone" placeholder="연락처" required>
                                            <br /><span id="checkPhone"></span>
                                        </div>
                                        <!-- 프로필 사진 업로드 필드 -->
                                        <div class="form-group mb-3">
                                            <label for="MProfile" class="form-label">프로필 사진</label>
                                            <input class="form-control" type="file" name="MProfile" id="MProfile">
                                        </div>
                                        <div class="alertMessage" id="alertMessage2"></div>
                                        <!-- 숨겨진 필드들 -->
                                        <input type="hidden" id="hidden-name" name="MName">
                                        <input type="hidden" id="hidden-email" name="MEmail">
                                        <!-- 가입 버튼 -->
                                        <div class="d-grid mt-3">
                                            <button type="submit" class="btn btn-primary">가입</button>
                                        </div>
                                        <p class="text-center mt-3 mb-0"><small>이미 계정이 있으신가요? <a href="login" class="fs-6 text-primary">로그인!</a></small></p>
                                    </form>
                                </div>
                            </div>

                            <!-- 세 번째 컨테이너 -->
                            <div id="third-form-container" class="fade-in">
                                <div class="text-center mt-3 px-lg-4 px-2">
                                    <div class="navbar-brand logo mb-3">
                                        <a class="navbar-caption fs-4 text-dark ls-1 fw-bold" href="index.html"><i class="ri-robot-2-fill text-danger fs-3 me-1"></i>Dev<b class="text-danger">Hub</b></a>
                                    </div>
                                    <div class="login-title">
                                        <h5 class="text-primary fw-semibold">가입이 완료되었습니다!</h5>
                                    </div>
                                    <p class="text-muted mb-0">잠시 후 메인 페이지로 이동합니다.</p>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="col-lg-5 text-start">
                    <img src="images/login.png" alt="" class="img-fluid">
                </div>
            </div>
        </div>
    </div>
</section>

<script src="https://cdn.lordicon.com/lordicon.js"></script>
<script src="/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/libs/swiper/swiper-bundle.min.js"></script>
<script src="/js/swiper.js"></script>
<script type="module" src="/js/app.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<script>
    // 알림 메시지를 표시하는 함수
    function showAlert(message, alertType, alertId) {
        const alertMessage = document.getElementById(alertId);
        alertMessage.style.display = 'block'; // 알림 메시지 표시
        alertMessage.className = 'alert ' + alertType; // 알림 메시지 타입 설정
        alertMessage.textContent = message; // 알림 메시지 내용 설정
        setTimeout(() => {
            alertMessage.style.display = 'none'; // 3초 후 알림 메시지 숨기기
        }, 3000);
    }

    // 알림 메시지를 숨기는 함수
    function hideAlert(alertId) {
        const alertMessage = document.getElementById(alertId);
        alertMessage.style.display = 'none'; // 알림 메시지 숨기기
    }

    let number; // 인증번호 저장 변수

    // 이름 유효성 검사
    let mName = $('#name'); // 이름 입력 필드
    let checkName = $('#checkName'); // 이름 유효성 검사 결과 메시지 표시할 요소

    // 이름 입력 필드에 입력할 때마다 유효성 검사 수행
    mName.keyup(() => {
        let nameVal = mName.val(); // 입력된 이름 값
        let nameRegEx = /^[가-힣a-zA-Z]+$/; // 한글 또는 영문만 허용하는 정규 표현식

        if (nameRegEx.test(nameVal)) {
            hideAlert('alertMessage1'); // 유효한 이름일 때 메시지 숨김
        } else {
            showAlert("이름에는 특수문자, 공백, 숫자를 사용할 수 없습니다.", "alert-danger", 'alertMessage1'); // 유효하지 않은 이름일 때 경고 메시지 표시
        }
    });

    // 이메일 유효성 검사
    function validateEmail(emailVal) {
        let emailRegEx = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/; // 도메인 형식 포함한 정규 표현식
        let specialCharRegEx = /[`~!#$%^&*|\\'\":;\/?]/; // 특수문자 검사 (@ 제외)
        let koreanCharRegEx = /[ㄱ-ㅎㅏ-ㅣ가-힣]/; // 한글 검사
        let spaceRegEx = /\s/; // 공백 검사

        // 허용된 최상위 도메인 목록
        const allowedTLDs = ['com', 'net', 'org', 'edu', 'gov', 'mil', 'co', 'kr'];

        if (!emailRegEx.test(emailVal)) {
            showAlert("유효하지 않은 이메일 형식입니다.", "alert-danger", 'alertMessage1'); // 유효하지 않은 이메일 형식일 때 경고 메시지 표시
            return false;
        }

        if (specialCharRegEx.test(emailVal)) {
            showAlert("이메일에는 특수문자, 공백, 한글을 포함할 수 없습니다.", "alert-danger", 'alertMessage1'); // 특수문자가 포함된 경우 경고 메시지 표시
            return false;
        }

        if (koreanCharRegEx.test(emailVal)) {
            showAlert("이메일에는 한글을 포함할 수 없습니다.", "alert-danger", 'alertMessage1'); // 한글이 포함된 경우 경고 메시지 표시
            return false;
        }

        if (spaceRegEx.test(emailVal)) {
            showAlert("이메일에는 공백을 포함할 수 없습니다.", "alert-danger", 'alertMessage1'); // 공백이 포함된 경우 경고 메시지 표시
            return false;
        }

        // 최상위 도메인 검사
        const domain = emailVal.split('.').pop();
        if (!allowedTLDs.includes(domain)) {
            showAlert(`허용되지 않은 도메인입니다. 허용된 도메인: ${allowedTLDs.join(', ')}`, "alert-danger", 'alertMessage1'); // 허용되지 않은 도메인일 때 경고 메시지 표시
            return false;
        }

        return true;
    }

    // 보내기 버튼 클릭 시
    document.getElementById('send-code-btn').addEventListener('click', function () {
        let email = $('#email').val(); // 이메일 입력 값

        // 이메일 유효성 검사
        if (!validateEmail(email)) {
            return; // 이메일이 유효하지 않으면 함수 종료
        }

        let verificationCodeGroup = document.getElementById('verification-code-group');
        verificationCodeGroup.classList.add('show'); // 인증번호 입력 그룹 표시
        this.textContent = '재전송'; // 버튼 텍스트 변경

        $.ajax({
            type: "post",
            url: "/emailCheck",
            data: {
                MEmail: email
            },
            dataType: "text",
            success: function (cnum) {
                number = cnum; // 서버로부터 받은 인증번호 저장
                console.log('인증번호 전송 성공:', cnum); // 콘솔에 성공 메시지 출력
                showAlert('인증번호를 전송했습니다.', 'alert-success', 'alertMessage1'); // 성공 메시지 표시
            },
            error: function () {
                console.log('인증번호 불러오기 실패'); // 콘솔에 오류 메시지 출력
                showAlert('인증번호 불러오기 실패', 'alert-danger', 'alertMessage1'); // 오류 메시지 표시
            }
        });
    });

    document.getElementById('first-form').addEventListener('submit', function (event) {
        event.preventDefault(); // 기본 제출 동작 방지

        // 이용약관 체크 여부 확인
        if (!$('#exampleCheck1').is(':checked')) {
            showAlert('이용약관에 동의해야 합니다.', 'alert-danger', 'alertMessage1'); // 동의하지 않았을 때 경고 메시지 표시
            return; // 조건이 충족되지 않으면 함수 종료
        }

        // 인증번호 일치 여부 확인
        if (number !== $('#verification-code').val()) {
            showAlert('인증번호가 일치하지 않습니다. 다시 시도해 주세요.', 'alert-danger', 'alertMessage1'); // 인증번호 불일치 시 경고 메시지 표시
            return; // 조건이 충족되지 않으면 함수 종료
        }

        // 첫 번째 폼을 숨기고 두 번째 폼을 표시
        let firstFormContainer = document.getElementById('first-form-container');
        let secondFormContainer = document.getElementById('second-form-container');

        let name = document.getElementById('name').value;
        let email = document.getElementById('email').value;

        document.getElementById('hidden-name').value = name; // 이름을 숨겨진 필드에 저장
        document.getElementById('hidden-email').value = email; // 이메일을 숨겨진 필드에 저장

        firstFormContainer.classList.add('fade-out'); // 첫 번째 폼에 페이드아웃 효과 추가

        setTimeout(function () {
            firstFormContainer.style.display = 'none'; // 첫 번째 폼 숨기기
            secondFormContainer.style.display = 'block'; // 두 번째 폼 표시
            secondFormContainer.classList.add('fade-in'); // 두 번째 폼에 페이드인 효과 추가
        }, 1000); // 1초 후 실행
    });

    let check_id = false; // 아이디 유효성 여부
    let check_pw = false; // 비밀번호 유효성 여부

    // 아이디 입력 필드에 입력할 때마다 유효성 검사 수행
    $('#MId').keyup(() => {
        let MId = $('#MId').val();
        let validIdRegEx = /^[a-zA-Z0-9]+$/; // 영문 대소문자와 숫자만 허용

        if (!validIdRegEx.test(MId)) {
            showAlert('아이디는 영문 대소문자와 숫자만 사용할 수 있습니다.', 'alert-danger', 'alertMessage2');
            check_id = false;
            return;
        }

        // ajax를 사용해서 아이디 중복체크
        $.ajax({
            type: "POST",
            url: "idCheck",
            data: {"MId": MId},
            dataType: "text",
            success: (result) => {
                if (result == "OK") {
                    check_id = true;
                    hideAlert('alertMessage2');
                } else {
                    check_id = false;
                    showAlert('사용 중인 아이디입니다.', 'alert-danger', 'alertMessage2');
                }
            },
            error: () => {
                showAlert('idCheck 함수 통신 실패!', 'alert-danger', 'alertMessage2');
            }
        });
    });

    // 비밀번호 확인 버튼 클릭 시
    $('#check-pw-btn').click(() => {
        let MPw = $('#MPw').val();
        let CheckPw = $('#CheckPw').val();

        if (MPw === CheckPw) {
            $('#MPw').addClass('input-valid').removeClass('input-error');
            $('#CheckPw').addClass('input-valid').removeClass('input-error');
            $('#check-pw-btn').addClass('valid').removeClass('invalid');
            hideAlert('alertMessage2');
            check_pw = true;
        } else {
            $('#MPw').addClass('input-error').removeClass('input-valid');
            $('#CheckPw').addClass('input-error').removeClass('input-valid');
            $('#check-pw-btn').addClass('invalid').removeClass('valid');
            showAlert('비밀번호가 일치하지 않습니다.', 'alert-danger', 'alertMessage2');
            check_pw = false;
        }
    });

    // 전화번호 유효성 검사
    $('#MPhone').keyup(() => {
        let phoneVal = $('#MPhone').val();
        let validPhoneRegEx = /^[0-9]{10,11}$/;  // 10자리 또는 11자리 숫자
        let nonDigitRegEx = /[^0-9]/; // 숫자가 아닌 문자 포함 여부

        if (nonDigitRegEx.test(phoneVal)) {
            showAlert("숫자만 입력하세요.", "alert-danger", 'alertMessage2');
        } else if (phoneVal.length >= 11) {
            if (phoneVal.length >= 12) {
                showAlert("유효하지 않은 연락처입니다. 12자리 이상의 숫자를 입력하세요.", "alert-danger", 'alertMessage2');
            } else if (validPhoneRegEx.test(phoneVal)) {
                hideAlert('alertMessage2'); // 유효한 연락처일 때 메시지 숨김
            } else {
                showAlert("유효하지 않은 연락처입니다. 이동전화 10자리 또는 11자리 숫자를 입력하세요.", "alert-danger", 'alertMessage2');
            }
        } else {
            hideAlert('alertMessage2');
        }
    });

    // 두 번째 폼 제출 시 유효성 검사 및 파일 업로드 처리 추가
    $('#second-form').on('submit', function (event) {
        event.preventDefault();
        let valid = true;

        if (!check_id) {
            valid = false;
            showAlert("아이디를 확인해주세요.", "alert-danger", 'alertMessage2');
        }

        if (!check_pw) {
            valid = false;
            showAlert("비밀번호를 확인해주세요.", "alert-danger", 'alertMessage2');
        }

        if (valid) {
            let fileInput = document.getElementById('MProfile');
            let formData = new FormData();
            formData.append('MProfile', fileInput.files[0]);
            formData.append('MId', $('#MId').val());
            formData.append('MPw', $('#MPw').val());
            formData.append('MName', $('#hidden-name').val());
            formData.append('MEmail', $('#hidden-email').val());
            formData.append('MBirth', $('#MBirth').val());
            formData.append('MGender', document.querySelector('input[name="MGender"]:checked').value);
            formData.append('MPhone', $('#MPhone').val());
            formData.append('MPoint', 0);

            $.ajax({
                url: '/mJoin', // Spring Boot Controller에 맞게 URL을 변경해야 합니다.
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    let secondFormContainer = document.getElementById('second-form-container');
                    let thirdFormContainer = document.getElementById('third-form-container');

                    secondFormContainer.classList.add('fade-out'); // 두 번째 폼에 페이드아웃 효과 추가

                    setTimeout(function () {
                        secondFormContainer.style.display = 'none'; // 두 번째 폼 숨기기
                        thirdFormContainer.style.display = 'block'; // 세 번째 폼 표시
                        thirdFormContainer.classList.add('fade-in'); // 세 번째 폼에 페이드인 효과 추가
                        setTimeout(function () {
                            window.location.href = 'login'; // 3초 후 로그인 페이지로 이동
                        }, 3000);
                    }, 1000);
                },
                error: function (error) {
                    console.error('파일 업로드 중 오류 발생:', error);
                    showAlert('파일 업로드 중 오류가 발생했습니다.', 'alert-danger', 'alertMessage2');
                }
            });
        }
    });

    // 입력 필드에 포커스를 줄 때 오류 클래스 제거
    document.querySelectorAll('.form-control').forEach(element => {
        element.addEventListener('focus', () => {
            element.classList.remove('input-error');
        });
    });
</script>


</body>
</html>
